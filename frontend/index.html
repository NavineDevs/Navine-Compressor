<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Navine Compressor</title>
<link rel="icon" href="data:,">

<style>
:root{
  --bg:#05070c;
  --card:#0b1222;
  --royal:#1f3cff;
  --electric:#00c8ff;
  --border:rgba(0,200,255,.25);
  --muted: rgba(230,241,255,.78);
}
body{
  margin:0; min-height:100vh; display:grid; place-items:center;
  background:radial-gradient(circle at top,#08142e,#05070c 70%);
  color:#e6f1ff; font-family:system-ui,Segoe UI,Arial;
}
.container{
  width:min(860px,94vw);
  background:linear-gradient(180deg,#0b1222,#070c18);
  border-radius:16px;
  padding:22px;
  box-shadow:0 0 35px rgba(0,200,255,.18), inset 0 0 0 1px var(--border);
}
header{
  display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
h1{
  margin:0;
  font-size:26px;
  color:var(--electric);
  text-shadow:0 0 12px rgba(0,200,255,.45);
}
.sub{ margin-top:6px; color:var(--muted); font-size:13px; }
.grid{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:18px;
  margin-top:16px;
}
@media (max-width: 900px){
  .grid{ grid-template-columns:1fr; }
}
.card{
  background:rgba(255,255,255,.03);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}
label{ font-size:13px; color:var(--muted); }
.row{ margin:12px 0; }
input, select{ width:100%; margin-top:6px; }
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  font-size:15px;
  font-weight:700;
  color:white;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:linear-gradient(135deg,var(--royal),var(--electric));
  box-shadow:0 0 18px rgba(0,200,255,.25);
}
button:disabled{ opacity:.55; cursor:not-allowed; }
.small{ font-size:12px; color:var(--muted); margin-top:6px; }

.progress{
  height:14px;
  background:#0a1020;
  border-radius:999px;
  overflow:hidden;
  border:1px solid var(--border);
  margin-top:12px;
}
.bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--royal),var(--electric));
  transition:width .12s linear;
}
.status{
  margin-top:8px;
  font-size:13px;
  text-align:center;
  white-space:pre-line;
  color:rgba(230,241,255,.92);
}
a{ color:var(--electric); }

.tabs{
  display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
}
.tab{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.02);
  cursor:pointer;
  font-size:13px;
  color:var(--muted);
}
.tab.active{
  background:rgba(0,200,255,.10);
  color:#e6f1ff;
  box-shadow:0 0 16px rgba(0,200,255,.12);
}

/* Image compare */
.compareWrap{
  margin-top:12px;
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border);
  background:#070c18;
}
.compare{
  position:relative;
  width:100%;
  aspect-ratio: 16/9;
  max-height: 420px;
}
.compare img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:contain;
  background:#070c18;
}
#afterImg{
  clip-path: inset(0 50% 0 0); /* controlled by slider */
}
.handle{
  position:absolute;
  top:0; bottom:0;
  width:2px;
  left:50%;
  background:rgba(0,200,255,.8);
  box-shadow:0 0 14px rgba(0,200,255,.55);
}
.compareSlider{
  width:100%;
  margin:0;
}
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:12px;
  color:var(--muted);
}
hr{
  border:none;
  border-top:1px solid rgba(0,200,255,.15);
  margin:14px 0;
}
</style>
</head>

<body>
<div class="container">
  <header>
    <div>
      <h1>Navine Compressor</h1>
      <div class="sub">Black √ó Royal Blue √ó Electric Blue ‚Ä¢ Images in-browser ‚Ä¢ Videos via Render (exact target size)</div>
    </div>
    <div class="badge" id="backendBadge">Backend: not set</div>
  </header>

  <div class="tabs">
    <div class="tab active" id="tabAuto">Auto (recommended)</div>
    <div class="tab" id="tabImage">Images</div>
    <div class="tab" id="tabVideo">Videos (Target MB)</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row">
        <label>Select file (image/video/audio)</label>
        <input id="file" type="file" />
        <div class="small" id="fileInfo">No file selected.</div>
      </div>

      <div id="autoPanel">
        <div class="row">
          <label>Auto mode behavior</label>
          <select id="autoMode">
            <option value="auto" selected>Auto: images local, videos server</option>
            <option value="localImagesOnly">Local images only</option>
            <option value="serverVideoOnly">Server video only</option>
          </select>
          <div class="small">Auto picks best route for quality + target sizing.</div>
        </div>

        <div class="row">
          <label>Render Backend URL</label>
          <input id="backendUrl" placeholder="https://YOUR-RENDER-SERVICE.onrender.com" />
          <div class="small">Used for video target sizing + progress. (Set once, saved in your browser.)</div>
        </div>

        <button id="startAuto">Start</button>
      </div>

      <div id="imagePanel" style="display:none;">
        <div class="row">
          <label>Image quality</label>
          <input id="imgQuality" type="range" min="60" max="95" value="85" />
          <div class="small" id="imgQualityTxt">Quality: 85</div>
        </div>

        <div class="row">
          <label>Image output format</label>
          <select id="imgFormat">
            <option value="keep" selected>Keep original (best effort)</option>
            <option value="image/jpeg">Convert to JPEG (smaller, no transparency)</option>
            <option value="image/webp">Convert to WebP (smaller, keeps transparency)</option>
          </select>
        </div>

        <button id="compressImageBtn">Compress Image</button>
      </div>

      <div id="videoPanel" style="display:none;">
        <div class="row">
          <label>Target size (MB)</label>
          <input id="targetMB" type="number" min="5" step="1" value="499" />
          <div class="small">Server uses FFmpeg 2-pass to hit this size accurately.</div>
        </div>

        <div class="row">
          <label>Codec</label>
          <select id="codec">
            <option value="h264" selected>H.264 (best compatibility)</option>
            <option value="h265">H.265 (smaller, slower)</option>
          </select>
        </div>

        <div class="row">
          <label>Audio bitrate (kbps)</label>
          <input id="audioKbps" type="number" min="64" step="16" value="128" />
        </div>

        <div class="row">
          <label>Auto quality detection</label>
          <select id="autoQuality">
            <option value="on" selected>ON (recommended)</option>
            <option value="off">OFF (use manual)</option>
          </select>
          <div class="small">Server will pick preset/filters based on resolution/duration.</div>
        </div>

        <button id="compressVideoBtn">Compress Video (Server)</button>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="status" id="status">Waiting‚Ä¶</div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div><span class="badge">üñºÔ∏è Image Preview / Compare</span></div>
      <div class="small">Pick an image and compress ‚Äî then drag the slider to compare before/after.</div>

      <div class="compareWrap">
        <div class="compare">
          <img id="beforeImg" alt="Before" />
          <img id="afterImg" alt="After" />
          <div class="handle" id="handle"></div>
        </div>
        <input class="compareSlider" id="compareSlider" type="range" min="0" max="100" value="50" />
      </div>

      <hr />

      <div><span class="badge">Downloads</span></div>
      <div class="small" id="downloads">No output yet.</div>
    </div>
  </div>
</div>

<script type="module">
import imageCompression from "https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/+esm";

/* ---------- UI helpers ---------- */
const $ = (id) => document.getElementById(id);
const fileEl = $("file");
const fileInfo = $("fileInfo");
const statusEl = $("status");
const bar = $("bar");
const downloads = $("downloads");

const tabAuto = $("tabAuto"), tabImage = $("tabImage"), tabVideo = $("tabVideo");
const autoPanel = $("autoPanel"), imagePanel = $("imagePanel"), videoPanel = $("videoPanel");

const backendUrlEl = $("backendUrl");
const backendBadge = $("backendBadge");

const imgQuality = $("imgQuality");
const imgQualityTxt = $("imgQualityTxt");
const imgFormat = $("imgFormat");

const beforeImg = $("beforeImg");
const afterImg = $("afterImg");
const compareSlider = $("compareSlider");
const handle = $("handle");

function setProgress(p){
  const pct = Math.max(0, Math.min(100, Math.round(p)));
  bar.style.width = pct + "%";
}
function setStatus(t){ statusEl.textContent = t; }
function fmtMB(bytes){ return (bytes / (1024*1024)).toFixed(2) + " MB"; }

function activateTab(which){
  for (const t of [tabAuto, tabImage, tabVideo]) t.classList.remove("active");
  autoPanel.style.display = "none";
  imagePanel.style.display = "none";
  videoPanel.style.display = "none";

  if (which === "auto"){ tabAuto.classList.add("active"); autoPanel.style.display = ""; }
  if (which === "image"){ tabImage.classList.add("active"); imagePanel.style.display = ""; }
  if (which === "video"){ tabVideo.classList.add("active"); videoPanel.style.display = ""; }
}
tabAuto.onclick = () => activateTab("auto");
tabImage.onclick = () => activateTab("image");
tabVideo.onclick = () => activateTab("video");

/* ---------- Slider compare ---------- */
function updateCompare(){
  const v = Number(compareSlider.value);
  afterImg.style.clipPath = `inset(0 ${100 - v}% 0 0)`;
  handle.style.left = v + "%";
}
compareSlider.oninput = updateCompare;
updateCompare();

/* ---------- Persist backend URL ---------- */
const savedBackend = localStorage.getItem("navine_backend") || "";
backendUrlEl.value = savedBackend;
function setBackendBadge(){
  backendBadge.textContent = "Backend: " + (backendUrlEl.value?.trim() ? "set" : "not set");
}
setBackendBadge();
backendUrlEl.addEventListener("change", () => {
  localStorage.setItem("navine_backend", backendUrlEl.value.trim());
  setBackendBadge();
});

/* ---------- File selection ---------- */
let lastSelectedUrl = null;
fileEl.onchange = async () => {
  const f = fileEl.files?.[0];
  if (!f){
    fileInfo.textContent = "No file selected.";
    return;
  }
  fileInfo.textContent = `${f.name} ‚Äî ${fmtMB(f.size)} ‚Äî ${f.type || "unknown type"}`;

  // If it's an image, show it in "before"
  if (f.type.startsWith("image/")){
    if (lastSelectedUrl) URL.revokeObjectURL(lastSelectedUrl);
    lastSelectedUrl = URL.createObjectURL(f);
    beforeImg.src = lastSelectedUrl;
    afterImg.src = "";
    downloads.textContent = "No output yet.";
    setStatus("Ready to compress image.");
    setProgress(0);
    activateTab("image");
  } else if (f.type.startsWith("video/") || f.type.startsWith("audio/")){
    activateTab("video");
    setStatus("Ready to compress video on server (target MB).");
    setProgress(0);
  } else {
    activateTab("auto");
    setStatus("This file type isn‚Äôt supported for compression (images/videos/audio only).");
    setProgress(0);
  }
};

/* ---------- Image compression (local) ---------- */
imgQuality.oninput = () => imgQualityTxt.textContent = "Quality: " + imgQuality.value;

$("compressImageBtn").onclick = async () => {
  const f = fileEl.files?.[0];
  if (!f) return alert("Select an image first.");
  if (!f.type.startsWith("image/")) return alert("Select a PNG/JPG/WebP image.");

  setStatus("Compressing image locally‚Ä¶");
  setProgress(2);

  try{
    const q = Number(imgQuality.value) / 100;
    const outType = imgFormat.value;

    const options = {
      initialQuality: q,
      useWebWorker: true,
      onProgress: (p) => setProgress(p),
    };

    // If converting, browser-image-compression uses fileType option:
    if (outType !== "keep") options.fileType = outType;

    const compressed = await imageCompression(f, options);

    const outUrl = URL.createObjectURL(compressed);
    afterImg.src = outUrl;
    compareSlider.value = 50;
    updateCompare();

    const nameBase = (f.name || "image").replace(/\.[^.]+$/, "");
    const ext = (outType === "keep") ? (f.name.split(".").pop() || "png") :
      (outType === "image/jpeg" ? "jpg" : "webp");

    downloads.innerHTML =
      `‚úÖ Image output: <b>${fmtMB(compressed.size)}</b><br>` +
      `<a href="${outUrl}" download="${nameBase}-navine.${ext}">Download image</a>`;

    setStatus("Done ‚úÖ Drag the slider to compare.");
    setProgress(100);
  }catch(e){
    console.error(e);
    setStatus("‚ùå Image compression failed.");
    setProgress(0);
  }
};

/* ---------- Video compression (server, target MB) ---------- */
async function requireBackend(){
  const base = backendUrlEl.value.trim().replace(/\/+$/,"");
  if (!base) throw new Error("Backend URL not set.");
  return base;
}

async function pollProgress(base, jobId){
  while(true){
    const r = await fetch(`${base}/api/progress/${jobId}`, { cache: "no-store" });
    if (!r.ok) throw new Error("Progress request failed.");
    const j = await r.json();

    setProgress(j.percent ?? 0);
    setStatus(j.message || "Working‚Ä¶");

    if (j.status === "done"){
      return j;
    }
    if (j.status === "error"){
      throw new Error(j.error || "Server error");
    }
    await new Promise(res => setTimeout(res, 900));
  }
}

$("compressVideoBtn").onclick = async () => {
  const f = fileEl.files?.[0];
  if (!f) return alert("Select a video/audio first.");
  if (!(f.type.startsWith("video/") || f.type.startsWith("audio/"))){
    return alert("Select a video or audio file.");
  }

  let base;
  try{
    base = await requireBackend();
  }catch(e){
    alert("Set your Render backend URL first.");
    return;
  }

  setStatus("Uploading to server‚Ä¶");
  setProgress(1);

  const targetMB = Number($("targetMB").value || 499);
  const codec = $("codec").value;
  const audioKbps = Number($("audioKbps").value || 128);
  const autoQuality = $("autoQuality").value;

  const fd = new FormData();
  fd.append("file", f);
  fd.append("targetMB", String(targetMB));
  fd.append("codec", codec);
  fd.append("audioKbps", String(audioKbps));
  fd.append("autoQuality", autoQuality);

  try{
    const start = await fetch(`${base}/api/start`, { method:"POST", body: fd });
    if (!start.ok){
      const text = await start.text();
      throw new Error(text || "Start failed");
    }
    const { jobId } = await start.json();
    setStatus("Encoding‚Ä¶");
    setProgress(2);

    const result = await pollProgress(base, jobId);

    const dlUrl = `${base}/api/download/${jobId}`;
    downloads.innerHTML =
      `‚úÖ Video output ready<br>` +
      `Target: <b>${targetMB} MB</b> ‚Ä¢ Output: <b>${result.outputMB?.toFixed?.(2) ?? "?"} MB</b><br>` +
      `<a href="${dlUrl}" target="_blank">Download video</a>`;

    setStatus("Done ‚úÖ");
    setProgress(100);
  }catch(e){
    console.error(e);
    setStatus("‚ùå Server compression failed.\n" + (e?.message || ""));
    setProgress(0);
  }
};

/* ---------- Auto mode ---------- */
$("startAuto").onclick = () => {
  const f = fileEl.files?.[0];
  if (!f) return alert("Select a file first.");

  const mode = $("autoMode").value;

  if (f.type.startsWith("image/")){
    activateTab("image");
    if (mode === "serverVideoOnly"){
      setStatus("Auto mode: you chose server only, but this is an image. Switch mode or use Images tab.");
    } else {
      setStatus("Auto mode: image ‚Üí local compression.");
    }
    return;
  }

  if (f.type.startsWith("video/") || f.type.startsWith("audio/")){
    activateTab("video");
    if (mode === "localImagesOnly"){
      setStatus("Auto mode: you chose images only, but this is a video. Switch mode or use Videos tab.");
    } else {
      setStatus("Auto mode: video ‚Üí server (target MB).");
    }
    return;
  }

  setStatus("Unsupported file type. Use image/video/audio only.");
};
</script>
</body>
</html>
